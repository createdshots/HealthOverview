<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Episode Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/firebaseConfig.js"></script>
    <link rel="stylesheet" href="/styles/main.css">
    <style>
        body {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #60a5fa 100%);
            min-height: 100vh;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 40px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 24px;
            bottom: -20px;
            width: 2px;
            background-color: #e5e7eb;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: -6px;
            top: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #3b82f6;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #3b82f6;
        }

        .timeline-item.critical .timeline-dot {
            background-color: #dc2626;
            box-shadow: 0 0 0 2px #dc2626;
        }

        .timeline-item.high .timeline-dot {
            background-color: #f97316;
            box-shadow: 0 0 0 2px #f97316;
        }

        .episode-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #1e40af;
        }
    </style>
</head>
<body class="text-gray-900">
    <div class="min-h-screen pb-8">
        <!-- Header -->
        <div class="episode-header text-white py-8 px-4 shadow-lg">
            <div class="max-w-4xl mx-auto">
                <button id="back-btn" class="mb-4 text-white hover:text-blue-100 flex items-center space-x-2">
                    <span>‚Üê</span>
                    <span>Back to Dashboard</span>
                </button>
                <div id="episode-header-content" class="text-center">
                    <h1 class="text-3xl font-bold mb-2">Loading...</h1>
                    <p class="text-blue-100">Episode Information</p>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-4xl mx-auto px-4 mt-8">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">üìã Episode Details</h2>
                <div id="episode-details-content" class="space-y-4">
                    <div class="text-center text-gray-500">Loading episode details...</div>
                </div>
            </div>

            <!-- Timeline Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">üìÖ Progression Timeline</h2>
                    <button id="edit-timeline-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                        ‚úèÔ∏è Edit Timeline
                    </button>
                </div>
                <div id="timeline-content" class="space-y-6 custom-scrollbar">
                    <div class="text-center text-gray-500">Loading timeline...</div>
                </div>
            </div>

            <!-- Notes Section -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">üìù Notes</h2>
                <div id="notes-content" class="text-gray-700 whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200">
                    No notes added
                </div>
            </div>

            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-lg p-6 flex space-x-4">
                <button id="delete-episode-btn" class="flex-1 bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition transform hover:scale-105">
                    üóëÔ∏è Delete Episode
                </button>
                <button id="close-episode-btn" class="flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition transform hover:scale-105">
                    ‚úÖ Mark as Resolved
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full"></div>
            <p class="mt-4 text-center text-gray-700">Processing...</p>
        </div>
    </div>

    <script type="module">
        import { onAuthStateChanged, auth } from '/firebaseConfig.js';
        import { EnhancedDataManager } from '/js/data/enhancedDataManager.js';
        import { MedicalEpisodeManager, MEDICAL_ISSUES } from '/js/features/medicalEpisodes.js';

        let currentEpisodeId = null;
        let episodeData = null;
        let dataManager = null;
        let episodeManager = null;
        let userId = null;

        // Get episode ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        currentEpisodeId = urlParams.get('id');

        if (!currentEpisodeId) {
            document.querySelector('#episode-header-content').innerHTML = '<p class="text-red-300">No episode ID provided. Redirecting to dashboard...</p>';
            setTimeout(() => window.location.href = '/dashboard.html', 2000);
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                dataManager = new EnhancedDataManager();
                dataManager.setUserId(userId);
                episodeManager = new MedicalEpisodeManager(dataManager);

                // Give Firebase a moment to sync
                setTimeout(() => loadEpisodeData(), 500);
            } else {
                window.location.href = '/login.html';
            }
        });

        async function loadEpisodeData() {
            try {
                console.log('Loading episode data for ID:', currentEpisodeId);
                await dataManager.loadUserData();
                const data = dataManager.getData();
                
                console.log('All medical episodes:', data.medicalEpisodes);
                episodeData = data.medicalEpisodes?.find(e => e.id === currentEpisodeId);
                console.log('Found episode:', episodeData);
                
                if (!episodeData) {
                    showError('Episode not found');
                    return;
                }

                renderEpisodeDetails();
            } catch (error) {
                console.error('Error loading episode:', error);
                showError('Failed to load episode details');
            }
        }

        function renderEpisodeDetails() {
            if (!episodeData) return;

            // Header
            document.querySelector('#episode-header-content').innerHTML = `
                <h1 class="text-3xl font-bold mb-2">${episodeData.issueName}</h1>
                <p class="text-blue-100">${episodeData.category} ‚Ä¢ ${new Date(episodeData.timestamp).toLocaleDateString()}</p>
            `;

            // Details
            const severityColors = {
                critical: 'bg-red-100 border-red-300 text-red-900',
                high: 'bg-orange-100 border-orange-300 text-orange-900',
                medium: 'bg-yellow-100 border-yellow-300 text-yellow-900',
                low: 'bg-green-100 border-green-300 text-green-900'
            };

            document.querySelector('#episode-details-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="text-sm text-gray-600">Severity</div>
                        <div class="text-lg font-bold mt-1">
                            <span class="px-3 py-1 rounded-full ${severityColors[episodeData.severity] || severityColors.medium}">
                                ${episodeData.severity.toUpperCase()}
                            </span>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="text-sm text-gray-600">Location</div>
                        <div class="text-lg font-bold text-gray-900 mt-1">üìç ${episodeData.location || 'Not specified'}</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="text-sm text-gray-600">Start Time</div>
                        <div class="text-lg font-bold text-gray-900 mt-1">${new Date(episodeData.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <div class="text-sm text-gray-600">Status</div>
                        <div class="text-lg font-bold text-blue-600 mt-1">${episodeData.status?.toUpperCase() || 'ACTIVE'}</div>
                    </div>
                </div>

                ${episodeData.requiresAmbulance ? `
                    <div class="mt-4 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                        <div class="font-semibold text-gray-900">üöë Ambulance Services</div>
                        <div class="text-sm text-gray-600 mt-1">This condition may require ambulance service</div>
                    </div>
                ` : ''}

                ${episodeData.requiresHospital ? `
                    <div class="mt-4 bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                        <div class="font-semibold text-gray-900">üè• Hospital Care</div>
                        <div class="text-sm text-gray-600 mt-1">This condition typically requires hospital care</div>
                    </div>
                ` : ''}
            `;

            // Timeline
            if (episodeData.progression && episodeData.progression.length > 0) {
                document.querySelector('#timeline-content').innerHTML = episodeData.progression.map(prog => `
                    <div class="timeline-item ${episodeData.severity}">
                        <div class="timeline-dot"></div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <div class="font-semibold text-gray-900">${getProgressionLabel(prog.type)}</div>
                            <div class="text-sm text-gray-600 mt-1">${new Date(prog.timestamp).toLocaleString()}</div>
                            ${prog.serviceName ? `<div class="text-sm text-gray-700 mt-2">Service: <strong>${prog.serviceName}</strong></div>` : ''}
                            ${prog.hospitalName ? `<div class="text-sm text-gray-700 mt-2">Hospital: <strong>${prog.hospitalName}</strong></div>` : ''}
                            ${prog.treatmentType ? `<div class="text-sm text-gray-700 mt-2">Treatment: <strong>${prog.treatmentType}</strong></div>` : ''}
                            ${prog.notes ? `<div class="text-sm text-gray-700 mt-2 italic">${prog.notes}</div>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                document.querySelector('#timeline-content').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>No progression events recorded yet.</p>
                        <p class="text-sm mt-2">Click "Edit Timeline" to add events.</p>
                    </div>
                `;
            }

            // Notes
            document.querySelector('#notes-content').textContent = episodeData.notes || 'No notes added';

            // Attach event listeners
            attachEventListeners();
        }

        function getProgressionLabel(type) {
            const labels = {
                'initial': 'üö® Initial Symptom',
                'ambulance_called': 'üöë Ambulance Called',
                'hospital_arrival': 'üè• Hospital Arrival',
                'treatment_started': 'üíä Treatment Started',
                'escalation': '‚ö†Ô∏è Condition Escalated',
                'observation': 'üëÅÔ∏è Under Observation',
                'recovery': '‚úÖ Recovery Stage',
                'discharge': 'üè† Discharged'
            };
            return labels[type] || type;
        }

        function attachEventListeners() {
            // Back button
            document.querySelector('#back-btn').addEventListener('click', () => {
                window.location.href = '/dashboard.html';
            });

            // Edit timeline
            document.querySelector('#edit-timeline-btn').addEventListener('click', () => {
                showTimelineEditor();
            });

            // Delete episode
            document.querySelector('#delete-episode-btn').addEventListener('click', async () => {
                if (confirm('Are you sure you want to delete this episode? This cannot be undone.')) {
                    await deleteEpisode();
                }
            });

            // Close episode
            document.querySelector('#close-episode-btn').addEventListener('click', async () => {
                episodeData.status = 'resolved';
                await saveEpisode();
                showSuccess('Episode marked as resolved');
                setTimeout(() => window.location.href = '/dashboard.html', 1000);
            });
        }

        function showTimelineEditor() {
            alert('Timeline editor coming soon! You can edit progressions directly from the dashboard for now.');
        }

        async function deleteEpisode() {
            showLoading(true);
            try {
                const data = dataManager.getData();
                const idx = data.medicalEpisodes.findIndex(e => e.id === currentEpisodeId);
                if (idx >= 0) {
                    data.medicalEpisodes.splice(idx, 1);
                    await dataManager.saveData();
                    showSuccess('Episode deleted');
                    setTimeout(() => window.location.href = '/dashboard.html', 1000);
                }
            } catch (error) {
                console.error('Error deleting episode:', error);
                showError('Failed to delete episode');
            }
            showLoading(false);
        }

        async function saveEpisode() {
            showLoading(true);
            try {
                const data = dataManager.getData();
                const episodeIdx = data.medicalEpisodes.findIndex(e => e.id === currentEpisodeId);
                if (episodeIdx >= 0) {
                    data.medicalEpisodes[episodeIdx] = episodeData;
                    await dataManager.saveData();
                }
            } catch (error) {
                console.error('Error saving episode:', error);
                showError('Failed to save episode');
            }
            showLoading(false);
        }

        function showLoading(show) {
            document.querySelector('#loading-spinner').classList.toggle('hidden', !show);
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg';
            div.textContent = message;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>
